# DNS中继服务器
北京邮电大学2023级计算机网络课程设计
## 1. 教学目的
本次课程设计旨在使我们深入理解 DNS协议的工作原理，掌握网络编程的基本技能，特别是 UDP 协议的应用。通过亲自动手实现一个 DNS 中继服务器，我们将能够：
- **理解 DNS 协议**: 熟悉 DNS 消息的格式、查询与响应流程，以及域名解析的核心机制。
- **掌握套接字编程**: 学习并应用 UDP 套接字进行数据收发，理解网络字节序与主机字节序的转换。
- **实践数据结构与算法**: 运用哈希表实现高效的域名查找和存储，结合链表实现 LRU缓存淘汰策略。
## 2. 核心功能
本次课程设计的主要内容是实现一个功能相对完整的 DNS 中继服务器（或称 DNS 代理）。该服务器将作为客户端和上游 DNS 服务器之间的桥梁，提供以下核心功能：
- **DNS 消息解析与构建**: 能够解析传入的 DNS 查询请求，并根据解析结果构建正确的 DNS 响应消息。
- **本地 DNS 解析**: 支持从本地配置文件 (`dnsrelay.txt`) 加载静态的域名到 IP 地址映射，优先响应这些本地配置的查询。
- **请求转发与响应回传**: 对于本地无法解析（既不在本地表也不在缓存中）的 DNS 请求，能够将其透明地转发到预设的上游公共 DNS 服务器，并将收到的上游响应回传给原始客户端。
- **事务 ID 管理**: 维护一个 DNS 事务 ID 映射表，以正确地将上游服务器的响应关联到对应的客户端请求，并支持超时过期清理。
- **I/O 多路复用**: 使用 `select()`函数实现基于阻塞 socket 的 I/O 多路复用机制，轮询监听本地 socket 与上游 DNS socket 的读事件，避免传统阻塞模型在并发处理多个客户端和上游响应时的性能瓶颈。
- **DNS 缓存机制**: 
  - **缓存存储**: 使用哈希表存储 DNS 响应中的域名和 IP 地址映射。
  - **LRU 淘汰策略**: 当缓存空间达到上限时，采用 LRU (Least Recently Used) 策略淘汰最久未使用的缓存条目，以保证缓存的有效性。
  - **缓存查找与更新**: 对于缓存命中的请求，直接返回缓存中的数据；同时更新命中条目的“最近使用”状态。
- **日志与调试**: 提供日志记录功能和调试输出，方便程序运行状态的监控和问题排查。
## 3. 实验方法
本次课程设计主要采用 C 语言进行实现，Windows环境下利用 Winsock 库进行网络编程。
- **模块化开发**: 将整个系统划分为多个模块：主模块(`main.c`)、 DNS 报文解析与构造模块 (`protocol.c`)、本地表模块 (`table.c`)、缓存模块 (`cache.c`)、服务通信模块(`server.c`)、工具与调试模块(`util.c`)。
- **增量式开发**: 
  - 第一步：实现基础的 DNS 协议解析和本地表查询，确保服务器能正确响应本地已知域名。
  - 第二步：增加中继功能，实现本地查不到时自动转发到上游DNS，并正确处理并发请求的 ID 映射。  
  - 第三步：实现超时检测与处理和ipv4/v6多协议支持，完善功能与健壮性。  
  - 第四步：引入缓存机制，优先从缓存查找，未命中再查本地表或中继，提升性能。缓存采用哈希表+LRU顺序管理，结合TTL自动失效。  
  - 第五步：完善调试与日志输出，便于测试和维护。
  
- **调试与测试**: 利用 `print_debug_info` 等调试函数输出关键流程和数据，辅助定位问题。
通过 nslookup、dig 等工具对服务器进行功能测试，验证本地解析、拦截、中继、缓存、超时等各项功能的正确性和稳定性。
## 4. 团队分工
孙明皓：
- 主流程控制: 搭建一个DNS服务器从启动，分配socket到终止，释放内存的顺序执行流程（`main.c`, `server.c`）
- 协议与报文处理: 编写要转发的DNS 报文的构造过程的相关代码（`protocol.c`）
- 本地表与数据结构: 负责本地域名-IP映射表的设计与实现（`table.c`）和 `uthash` 的集成和使用

李志敏：
- 网络通信: 实现向上游服务器转发功能，包括ID映射表、中继转发、超时处理等（`server.c`）

杨睿博：
- 缓存与LRU管理: 负责LRU缓存模块的设计与实现（`cache.c`）
- 用户接口与日志: 编写处理命令行输入，实现多级调试信息的工具函数（`util.c`）
## 5. 编译与运行
本程序使用cmake构建，支持`win/linux`双系统，可使用IDE的`cmake`工具/插件进行编译，或者使用原生命令行，如：
```shell
mkdir build
cd build
cmake ..
cmake --build .
```
程序接受命令行参数格式如：
```
dnsrelay [-d|-dd] [dns-server-ipaddr] [filename]
```
- `-d`：启用调试模式 1（打印查询信息）。
- `-dd`：启用调试模式 2（打印详细调试信息）
- `dns-server-ipaddr`：指定 DNS 服务器的 IP 地址。
- `filename`：指定包含静态 DNS 条目的文件名。

您也可以使用`dnsrelay -h|--helper`命令查看参数详细说明。
## 鸣谢
本程序利用了 `uthash` 库，这是一个轻量级的 C 语言哈希表实现，可在以下网址获得：[https://github.com/troydhanson/uthash](https://github.com/troydhanson/uthash) .

我们要感谢 Troy D. Hanson 创建并分享了这个有用的库，它为我们的简易 DNS 中继服务器的功能做出了重要贡献。
